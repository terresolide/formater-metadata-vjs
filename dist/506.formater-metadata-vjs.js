"use strict";(self.webpackChunkformater_metadata_vjs=self.webpackChunkformater_metadata_vjs||[]).push([[506],{8506:(e,t,r)=>{r.r(t),r.d(t,{default:()=>n});const s={name:"FormaterApiRequester",props:{api:{type:String,default:null},cds:{type:String,default:null},depth:{type:Number,default:1}},watch:{$route:function(e,t){this.getRecords(e)}},computed:{isFlatsim:function(){return this.api.indexOf("flatsim")>0}},data:function(){return{headers:{Accept:"application/json, text/plain, */*","Accept-Language":"fr"===this.$store.state.lang?"fre,eng":"eng,fre"},first:!0,dimensions:[],parameters:{},closeMetadataListener:null,resetListener:null,facet:[],type:"opensearch",credentials:{}}},created:function(){this.getRecords(this.$route)},destroyed:function(){},mounted:function(){},methods:{initParameters:function(){this.parameters={index:1,maxRecords:this.$store.state.size.nbRecord}},getRecords:function(e){this.$store.commit("searchingChange",!0),this.prepareRequest(e),this.requestApi(event)},prepareRequest:function(e){this.initParameters(),this.parameters=Object.assign(this.parameters,e.query),this.mapParameters()},mapParameters:function(){var e=this.$store.state.parameters.others,t=this.$store.state.parameters.mapping;for(var r in this.parameters.renameProperty("bbox",t.box),this.parameters.from&&(this.parameters.index=this.parameters.from,this.parameters.to&&(this.parameters.maxRecords=parseInt(this.parameters.to)-parseInt(this.parameters.from)+1)),this.parameters)void 0!==t[r]?this.parameters.renameProperty(r,t[r]):e.find((function(e){if(e.name===r)return!0}))||delete this.parameters[r]},requestApi:function(e){var t=this;if(this.api){var r=this.api+(this.api.indexOf("?")>0?"&":"?"),s=Object.assign({},this.parameters);s=Object.assign(s,this.$store.state.parameters.fixed),r+=Object.keys(s).map((function(e){return e+"="+s[e]})).join("&"),this.$emit("registerValues",{depth:e,parameters:this.parameters}),this.$http.get(r).then((function(r){t.treatmentGeojson(r.body,e)}),(function(s){t.treatmentError(s,r,e)}))}else this.$store.commit("searchingChange",!1)},treatmentError:function(e,t,r){var s=this;if(e&&this.$store.state.proxy.url)t=this.$store.state.proxy.url+"?url="+encodeURIComponent(t),this.$http.get(t).then((function(e){s.treatmentGeojson(e.body,r)}),(function(e){s.treatmentError(null,t,r)}));else{switch(e.status){case 0:this.$store.commit("setError","Maybe CORS ERROR, try with proxy");break;case 403:this.$store.commit("setError","SERVER RESPONSE FOR "+t+" : ACCESS DENIED");break;case 404:this.$store.commit("setError","SERVER RESPONSE FOR "+t+" : PAGE NOT FOUND");break;default:this.$store.commit("setError","UNKNOWN ERROR FOR "+t)}this.$store.commit("searchingChange",!1)}},treatmentGeojson:function(e,t){var r={},s=this,i=[];if(e.features.forEach((function(e){e.id||(e.id=e.properties.productIdentifier),e.properties.id=e.id,r[e.id]=s.mapToGeonetwork(e.properties),i.push({type:e.type,id:e.id,geometry:e.geometry})})),0===e.features.length&&(r={}),e.properties)var a=e.properties;else a=e.description;a.startIndex&&(a.startIndex=parseInt(a.startIndex)),a.totalResults&&(a.totalResults=parseInt(a.totalResults)),a.itemsPerPage&&(a.itemsPerPage=parseInt(a.itemsPerPage)),this.fill({type:"opensearch",properties:a,features:i,metadata:r},t),this.$store.commit("searchingChange",!1)},mapToGeonetwork:function(e){if((e=Object.assign({},e)).fromOs=!0,e.cds=this.cds,e.date){var t=e.date.split("/");t.length>1&&(e.tempExtentBegin=t[0],e.tempExtentEnd=t[1])}if(e.productIdentifier&&e.renameProperty("productIdentifier","identifier"),e.startDate&&e.renameProperty("startDate","tempExtentBegin"),e.completionDate&&e.renameProperty("completionDate","tempExtentEnd"),e.updated&&e.renameProperty("updated","revisionDate"),e.published&&e.renameProperty("published","publicationDate"),e.produced&&e.renameProperty("produced","creationDate"),e.type||(e.type="dataset"),e.quicklook&&(e.images=[["",e.quicklook,""]],delete e.quicklook),e.license&&!this.isFlatsim&&(e.legalConstraints=[e.license.licenseId]),e.osParameters=[],e.mapping=[],e.services&&(e.services.browse&&e.services.browse.layers&&(e.layers=[],e.services.browse.layers.forEach((function(t,r){t.type;var s={id:e.id+"_"+r,name:t.name,description:t.name,href:t.url,type:t.type,checked:!1};e.layers.push(s)}))),e.services.download&&e.services.download.url&&(e.download||(e.download=[]),e.download.push(e.services.download)),delete e.services),e.exportLinks||(e.exportLinks={}),e.offering&&e.offering.operation&&"GetMap"===e.offering.operation["@code"]&&(e.layers=[],e.layers.push({id:e.id,name:e.title,description:"",href:e.offering.operation["@href"],type:"GetMap"})),e.links){for(var r=e.links.length;r--;)"Download"!==e.links[r]["@title"]?"Browse"!==e.links[r]["@title"]?"via"!==e.links[r].rel?"application/json"!==e.links[r]["@type"]||e.exportLinks.json?"application/xml"!==e.links[r]["@type"]||e.exportLinks.xml?"application/json"!==e.links[r].type||e.exportLinks.json?"application/xml"!==e.links[r].type||e.exportLinks.xml||(e.exportLinks.xml=e.links[r].href,e.links.splice(r,1)):(e.exportLinks.json=e.links[r].href,e.links.splice(r,1)):(e.exportLinks.xml=e.links[r]["@href"],e.links.splice(r,1)):(e.exportLinks.json=e.links[r]["@href"],e.links.splice(r,1)):e.links.splice(r,1):(e.images=[["Browse",e.links[r]["@href"],""]],e.thumbnail=e.links[r]["@href"],e.links.splice(r,1)):(e.download||(e.download=[]),e.download.push({url:e.links[r]["@href"],mimeType:e.links[r]["@type"]}),e.links.splice(r,1));0===e.links.length&&delete e.links}if(!e.contacts&&(e.contacts={metadata:{},resource:{}},e.organisationName&&"string"==typeof e.organisationName)){var s=new Array(10);s[0]="Point of contact",s[2]=e.organisationName,e.contacts.metadata["Point of contact"]=[s],delete e.organisationName}if(e.keywords&&(e.keyword=[],e.keywords.forEach((function(t){e.keyword.push(t.name)})),delete e.keywords),e.categories){var i=[];e.categories.forEach((function(e){e["@term"]&&i.push(e["@term"])})),i.length>0&&(e.keyword=i)}return e.keyword||(e.keyword=[]),e},fill:function(e,t){e.depth=this.depth;var r=new CustomEvent("fmt:metadataListEvent",{detail:e});document.dispatchEvent(r)}}};var i=r(1900);const a={name:"FormaterOpensearch",components:{FormaterApiRequester:(0,i.Z)(s,(function(){return(0,this._self._c)("div")}),[],!1,null,null,null).exports},props:{describe:{type:String,default:null},cds:{type:String,default:null},uuid:{type:String,default:null},depth:{type:Number,default:null},service:{type:Object,default:null}},watch:{service:function(e){e.domain.indexOf("flatsim")>=0&&(this.osParameters=this.osParameters.filter((function(e){return"processingLevel"!==e.name})),this.$emit("parametersChange",{api:this.api,parameters:this.osParameters,mapping:this.mappingParameters,fixed:this.fixedParameters}))}},created:function(){this.load()},mounted:function(){},destroyed:function(){},data:function(){return{api:null,fixedParameters:{},paramNS:"parameters",mappingParameters:[],osParameters:[]}},methods:{extractFixedParams:function(e){var t=e.split("?"),r={};return t.length>1&&t[1].split("&").forEach((function(e){var t=e.split("=");r[t[0]]=t[1]})),this.fixedParameters=r,t[0]},load:function(){var e=this,t=this.extractFixedParams(this.describe);this.$http.get(t).then((function(t){e.extractDescribeParameters(t.body)}),(function(t){if(403===t.status||401===t.status||400===t.status)return console.log("CAN NOT GET "+e.describe),void e.$emit("failed");e.loadWithProxy()}))},loadWithProxy:function(){var e=this;if(this.$store.state.proxy.url){var t=this.$store.state.proxy.url+"?url="+encodeURIComponent(this.describe);this.$http.get(t).then((function(t){e.extractDescribeParameters(t.body)}),(function(t){e.$emit("failed")}))}else console.log("CAN NOT GET "+this.describe),this.$emit("failed")},extractParameter:function(e,t){var r,s,i=this.$store.getters.predefinedParams,a=(r=i,s=t,Object.keys(r).find((function(e){return s=s.replace("?",""),r[e]===s}))),n=e.getAttribute("name");if(!this.fixedParameters[n])if(void 0===a){var o={name:n,title:e.getAttribute("title")};if("processingLevel"===n&&this.service&&this.service.domain.indexOf("flatsim")>=0)return;var p=e.getAttribute("pattern");p&&(o=Object.assign(o,{pattern:p}));var l=e.getAttribute("minInclusive");l&&(o=Object.assign(o,{min:l}));var m=e.getAttribute("maxInclusive");m&&(o=Object.assign(o,{max:m}));var c=e.getElementsByTagName(this.paramNS+":Options");if(0===c.length&&(c=e.getElementsByTagName(this.paramNS+":Option")),1!==c.length){if(c.length>0){for(var d=[],h=0;h<c.length;h++)d.push(c[h].getAttribute("value"));d.length>0&&(o=Object.assign(o,{options:d}))}(!o.options||o.options.length>1)&&this.osParameters.push(o)}}else this.mappingParameters[a]=n},extractNamespaces:function(e){for(var t={},r=0;r<e.length;r++)if(e[r].value.indexOf("parameters")>0){var s=e[r].name.split(":");this.paramNS=s[1]}else e[r].value.indexOf("time")>0?(s=e[r].name.split(":"),t.time=s[1]):e[r].value.indexOf("geo")>0&&(s=e[r].name.split(":"),t.geo=s[1]);this.$store.commit("setNamespaces",t)},extractDescribeParameters:function(e){var t=(new DOMParser).parseFromString(e,"text/xml");this.extractNamespaces(t.firstElementChild.attributes);var r=t.firstElementChild.childNodes,s=null;if(r.forEach((function(e){if(e.tagName&&"url"===e.tagName.toLowerCase()&&e.getAttribute("type").indexOf("json")>=0&&e.getAttribute("type").indexOf("tdensity")<0&&e.getAttribute("type").indexOf("elasticsearch")<0){var t=e.getAttribute("template").match(/^([^?]*(?:\?)).*$/i);t&&t[1]&&""!=t[1]&&(s=e)}})),s){var i=s.getAttribute("template").match(/^([^?]*(?:\?)).*$/i);if(i[1]){this.api=i[1];for(var a=s.getElementsByTagName(this.paramNS+":Parameter"),n=this.$store.state.parameters.excluedRegex,o=0;o<a.length;o++){var p=a[o].getAttribute("value");p=p.replace("?",""),n.some((function(e){return new RegExp(e).test(p)}))||this.extractParameter(a[o],p)}this.$emit("parametersChange",{api:this.api,parameters:this.osParameters,mapping:this.mappingParameters,fixed:this.fixedParameters})}}}}},n=(0,i.Z)(a,(function(){var e=this,t=e._self._c;return e.api?t("formater-api-requester",{attrs:{api:e.api,cds:e.cds,depth:e.depth}}):e._e()}),[],!1,null,null,null).exports}}]);
//# sourceMappingURL=506.formater-metadata-vjs.js.map
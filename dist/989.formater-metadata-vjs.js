(self.webpackChunkformater_metadata_vjs=self.webpackChunkformater_metadata_vjs||[]).push([[989],{9858:e=>{e.exports=function(e){e.options.__i18n=e.options.__i18n||[],e.options.__i18n.push('{"fr":{"SERVICE_UNAVAILABLE":"Le service est indisponible. Veuillez revenir plus tard!"},"en":{"SERVICE_UNAVAILABLE":"The service is unavailable. Please come back later!"}}'),delete e.options._Ctor}},7989:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>l});const s={name:"FormaterElasticsearchRequester",props:{group:{type:String,default:null},depth:{type:Number,default:0}},watch:{$route:function(e,t){this.getRecords(e)}},data:function(){return{srv:null,api:null,headers:{Accept:"application/json, text/plain, */*","Accept-Language":"fr"===this.$store.state.lang?"fre,eng":"eng,fre"},first:!0,dimensions:[],parameters:{},changePageListener:null,temporalChangedListener:null,spatialChangedListener:null,dimensionChangedListener:null,textChangedListener:null,selectChangedListener:null,closeMetadataListener:null,resetListener:null,facet:[],type:"geonetwork",credentials:{}}},created:function(){this.$store.state.geonetwork&&(this.srv=this.$store.state.geonetwork+"srv/api/search/records/_search?bucket=metadata"),this.getRecords(this.$route)},destroyed:function(){},mounted:function(){},methods:{initParameters:function(){this.parameters={from:0,size:this.$store.state.size.nbRecord,_source:{includes:this.$store.state.includes},sort:[{changeDate:"desc"},{popularity:"desc"}],query:{bool:{filter:[{term:{isTemplate:"n"}},{terms:{resourceType:["dataset","series"]}}],must_not:{exists:{field:"parentUuid"}}}}}},getRecords:function(e){this.$store.commit("searchingChange",!0),this.type="geonetwork",this.prepareRequest(e),this.requestApi(e)},prepareRequest:function(e){if(this.initParameters(),"Metadata"===e.name){var t=Object.assign(this.$store.state.aggregations.step2);this.parameters.query.bool.filter.push({term:{parentUuid:e.params.uuid}}),delete this.parameters.query.bool.must_not}else t=Object.assign(this.$store.state.aggregations.step1);if(this.parameters.aggregations=t,e.query.from&&(this.parameters.from=parseInt(e.query.from)-1),e.query.to&&(this.parameters.size=parseInt(e.query.to)-this.parameters.from),e.query.sortBy&&"popularity"===e.query.sortBy&&this.parameters.sort.reverse(),(e.query.start||e.query.end)&&this.parameters.query.bool.filter.push({range:{resourceTemporalExtentDateRange:{from:e.query.start?e.query.start:null,to:e.query.end?e.query.end:null,format:"yyyy-MM-dd"}}}),e.query.box){var r=e.query.box.split(",");4===r.length&&this.parameters.query.bool.filter.push({geo_bounding_box:{location:{bottom_left:{lat:parseFloat(r[1]),lon:parseFloat(r[0])},top_right:{lat:parseFloat(r[3]),lon:parseFloat(r[2])}}}})}if(e.query.any){var s=e.query.any.trim().split(/(\s+)/),a={query_string:{fields:["resourceTitleObject.*","resourceAbstractObject.*","lineageObject.*","tag","uuid","resourceIdentifier"],query:(s=s.filter((function(e){return e.trim().length>0}))).join(" AND ")}};this.parameters.query.bool.must||(this.parameters.query.bool.must=[]),this.parameters.query.bool.must.push(a)}for(var n in this.group&&(this.parameters.query.bool.filter.push({term:{groupOwner:this.group}}),delete t.groupOwner),t)if(e.query[n])if("dimension"===t[n].meta.type){var o={},i=decodeURIComponent(e.query[n]).split("+or+");o[t[n].terms.field]=i,this.parameters.query.bool.filter.push({terms:o})}else(a={})[t[n].terms.field]=decodeURIComponent(e.query[n]),this.parameters.query.bool.filter.push({term:a});this.aggregations=t},searchSimpleMetadata:function(){var e=this;this.$http.get(this.$store.state.metadata).then((function(t){var r=t.body,s=r["geonet:info"].uuid;console.log(r);var a=e.$gn.treatmentMetadata(r,s);a.appRoot=!0;var n=new CustomEvent("fmt:metadataEvent",{detail:{meta:a,depth:0}});document.dispatchEvent(n)}))},requestApi:function(e){var t=this;this.srv&&this.$http.post(this.srv,this.parameters,{headers:{Accept:"application/json"}}).then((function(e){console.log(e.body),t.treatmentElasticsearch(e.body,0)}),(function(e){t.treatmentError(e,url)}))},treatmentError:function(e,t){switch(e.status){case 0:this.$store.commit("setError",this.$i18n.t("SERVICE_UNAVAILABLE"));break;case 403:this.$store.commit("setError","SERVER RESPONSE FOR "+t+" : ACCESS DENIED");break;case 404:this.$store.commit("setError","SERVER RESPONSE FOR "+t+" : PAGE NOT FOUND");break;default:this.$store.commit("setError","UNKNOWN ERROR FOR "+t)}this.$store.commit("searchingChange",!1)},treatmentElasticsearch:function(e,t){if(0===this.parameters.from&&e.hits&&e.hits.hits&&0===e.hits.hits.length)this.$store.commit("searchingChange",!1);else{this.treatmentAggregations(e.aggregations);var r={},s=[],a=this;e.hits&&e.hits.hits&&e.hits.hits.forEach((function(e,t){var n=e._id,o={type:"Feature",id:n,geometry:e._source.geom};o&&(o.geometry[0]&&(o.geometry=o.geometry[0]),s.push(o)),r[n]=a.$gn.treatmentMetaElasticsearch(e,n)})),e.summary={from:this.parameters.from+1,to:this.parameters.from+s.length,total:e.hits.total.value,dimension:[]},e.metadata=r,e.type="geonetwork",e.features={type:"FeatureCollection",features:s},delete e.hits,delete e.aggregations,this.fill(e,t),this.$store.commit("searchingChange",!1)}},treatmentAggregations:function(e){var t=this,r=[],s=[];for(var a in r=[],e)e[a].buckets.length>0&&(e[a].key=a,r.push(e[a]));for(var a in r.sort((function(e,t){return e.meta.sort-t.meta.sort})),r)s.push(this.prepareAggregation(r[a]));Promise.all(s).then((function(e){var r={dimension:e};r.depth=t.depth;var s=new CustomEvent("fmt:dimensionEvent",{detail:r});document.dispatchEvent(s)}))},translate:function(e,t){var r=this;return new Promise((function(s,a){var n=t.join(","),o="fr"===r.$store.state.lang?"fre":"eng",i=r.$store.state.geonetwork+"srv/api/registries/vocabularies/keyword?id="+encodeURIComponent(n)+"&thesaurus="+e+"&lang="+o;r.$http.get(i,{headers:{accept:"application/json"}}).then((function(e){s(e.body)}))}))},prepareAggregation:function(e){var t=this;return new Promise((function(r,s){var a=e.key,n=t.$store.state.lang;e.meta&&e.meta.label&&(a=e.meta.label[n]?e.meta.label[n]:e.meta.label);var o=t.aggregations[e.key].terms.field.split("."),i=o.length>1&&"key"===o[1],l={"@name":e.key,type:i?"associative":"simple",label:a,meta:e.meta,category:[]},u=e.meta&&e.meta.type||"dimension",h=e.buckets,c=t.$gn.groups,m=(n=t.$store.state.lang,[]),p=e.meta.thesaurus||null;h.forEach((function(t,r){if(h[r]["@value"]=t.key,"dimension"===u){if("groupOwner"===e.key)var s=c[t.key].label[n];else s=t.key;l.category.push({"@name":s,"@label":s,"@value":t.key,"@count":t.doc_count})}else if("select"!==u||i){var a=t.key.split("^"),o=a.pop();m.push(o),h[r].parent=a.join("^"),h[r].length=a.length,h[r]["@name"]=t.key,h[r]["@label"]=t.key,h[r]["@value"]=o,h[r]["@count"]=t.doc_count,delete t.doc_count}else console.log(s),console.log(t),l.category.push(t["@value"])})),i?t.translate(p,m).then((function(e){if(h.forEach((function(t,r){e[t["@value"]]&&(e[t["@value"]].label?h[r]["@label"]=e[t["@value"]].label:h[r]["@label"]=e[t["@value"]])})),"select"===u){var t=[];h.forEach((function(e){t.push({"@value":e["@value"],"@label":e["@label"]})}))}else t=function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return t.filter((function(e){return e.parent===r})).map((function(r){var s=e(t,r.key);return s.length>0&&(r.category=s),r}))}(h);l.category=t,r(l)})):r(l)}))},fill:function(e,t){e.depth=this.depth;var r=new CustomEvent("fmt:metadataListEvent",{detail:e});document.dispatchEvent(r)}}};var a=r(1900),n=r(9858);const o=r.n(n)();var i=(0,a.Z)(s,(function(){return(0,this._self._c)("div")}),[],!1,null,null,null);"function"==typeof o&&o(i);const l=i.exports}}]);
//# sourceMappingURL=989.formater-metadata-vjs.js.map
(self.webpackChunkformater_metadata_vjs=self.webpackChunkformater_metadata_vjs||[]).push([[237,989],{9858:e=>{e.exports=function(e){e.options.__i18n=e.options.__i18n||[],e.options.__i18n.push('{"fr":{"SERVICE_UNAVAILABLE":"Le service est indisponible. Veuillez revenir plus tard!"},"en":{"SERVICE_UNAVAILABLE":"The service is unavailable. Please come back later!"}}'),delete e.options._Ctor}},6282:e=>{e.exports=function(e){e.options.__i18n=e.options.__i18n||[],e.options.__i18n.push('{"en":{"searching":"Searching"},"fr":{"searching":"Recherche en cours"}}'),delete e.options._Ctor}},7989:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>l});const r={name:"FormaterElasticsearchRequester",props:{group:{type:String,default:null},depth:{type:Number,default:0}},watch:{$route:function(e,t){this.getRecords(e)}},data:function(){return{srv:null,api:null,headers:{Accept:"application/json, text/plain, */*","Accept-Language":"fr"===this.$store.state.lang?"fre,eng":"eng,fre"},first:!0,dimensions:[],parameters:{},changePageListener:null,temporalChangedListener:null,spatialChangedListener:null,dimensionChangedListener:null,textChangedListener:null,selectChangedListener:null,closeMetadataListener:null,resetListener:null,facet:[],type:"geonetwork",credentials:{}}},created:function(){this.$store.state.geonetwork&&(this.srv=this.$store.state.geonetwork+"srv/api/search/records/_search?bucket=metadata"),this.getRecords(this.$route)},destroyed:function(){},mounted:function(){},methods:{initParameters:function(){this.parameters={from:0,size:this.$store.state.size.nbRecord,_source:{includes:this.$store.state.includes},sort:[{changeDate:"desc"},{popularity:"desc"}],query:{bool:{filter:[{term:{isTemplate:"n"}},{terms:{resourceType:["dataset","series"]}}],must_not:{exists:{field:"parentUuid"}}}}}},getRecords:function(e){this.$store.commit("searchingChange",!0),this.type="geonetwork",this.prepareRequest(e),this.requestApi(e)},prepareRequest:function(e){if(this.initParameters(),"Metadata"===e.name){var t=Object.assign(this.$store.state.aggregations.step2);this.parameters.query.bool.filter.push({term:{parentUuid:e.params.uuid}}),delete this.parameters.query.bool.must_not}else t=Object.assign(this.$store.state.aggregations.step1);if(this.parameters.aggregations=t,e.query.from&&(this.parameters.from=parseInt(e.query.from)-1),e.query.to&&(this.parameters.size=parseInt(e.query.to)-this.parameters.from),e.query.sortBy&&"popularity"===e.query.sortBy&&this.parameters.sort.reverse(),(e.query.start||e.query.end)&&this.parameters.query.bool.filter.push({range:{resourceTemporalExtentDateRange:{from:e.query.start?e.query.start:null,to:e.query.end?e.query.end:null,format:"yyyy-MM-dd"}}}),e.query.box){var a=e.query.box.split(",");4===a.length&&this.parameters.query.bool.filter.push({geo_bounding_box:{location:{bottom_left:{lat:parseFloat(a[1]),lon:parseFloat(a[0])},top_right:{lat:parseFloat(a[3]),lon:parseFloat(a[2])}}}})}if(e.query.any){var r=e.query.any.trim().split(/(\s+)/),s={query_string:{fields:["resourceTitleObject.*","resourceAbstractObject.*","lineageObject.*","tag","uuid","resourceIdentifier"],query:(r=r.filter((function(e){return e.trim().length>0}))).join(" AND ")}};this.parameters.query.bool.must||(this.parameters.query.bool.must=[]),this.parameters.query.bool.must.push(s)}for(var i in this.group&&(this.parameters.query.bool.filter.push({term:{groupOwner:this.group}}),delete t.groupOwner),t)if(e.query[i])if("dimension"===t[i].meta.type){var n={},o=decodeURIComponent(e.query[i]).split("+or+");n[t[i].terms.field]=o,this.parameters.query.bool.filter.push({terms:n})}else(s={})[t[i].terms.field]=decodeURIComponent(e.query[i]),this.parameters.query.bool.filter.push({term:s});this.aggregations=t},searchSimpleMetadata:function(){var e=this;this.$http.get(this.$store.state.metadata).then((function(t){var a=t.body,r=a["geonet:info"].uuid;console.log(a);var s=e.$gn.treatmentMetadata(a,r);s.appRoot=!0;var i=new CustomEvent("fmt:metadataEvent",{detail:{meta:s,depth:0}});document.dispatchEvent(i)}))},requestApi:function(e){var t=this;this.srv&&this.$http.post(this.srv,this.parameters,{headers:{Accept:"application/json"}}).then((function(e){console.log(e.body),t.treatmentElasticsearch(e.body,0)}),(function(e){t.treatmentError(e,url)}))},treatmentError:function(e,t){switch(e.status){case 0:this.$store.commit("setError",this.$i18n.t("SERVICE_UNAVAILABLE"));break;case 403:this.$store.commit("setError","SERVER RESPONSE FOR "+t+" : ACCESS DENIED");break;case 404:this.$store.commit("setError","SERVER RESPONSE FOR "+t+" : PAGE NOT FOUND");break;default:this.$store.commit("setError","UNKNOWN ERROR FOR "+t)}this.$store.commit("searchingChange",!1)},treatmentElasticsearch:function(e,t){if(0===this.parameters.from&&e.hits&&e.hits.hits&&0===e.hits.hits.length)this.$store.commit("searchingChange",!1);else{this.treatmentAggregations(e.aggregations);var a={},r=[],s=this;e.hits&&e.hits.hits&&e.hits.hits.forEach((function(e,t){var i=e._id,n={type:"Feature",id:i,geometry:e._source.geom};n&&(n.geometry[0]&&(n.geometry=n.geometry[0]),r.push(n)),a[i]=s.$gn.treatmentMetaElasticsearch(e,i)})),e.summary={from:this.parameters.from+1,to:this.parameters.from+r.length,total:e.hits.total.value,dimension:[]},e.metadata=a,e.type="geonetwork",e.features={type:"FeatureCollection",features:r},delete e.hits,delete e.aggregations,this.fill(e,t),this.$store.commit("searchingChange",!1)}},treatmentAggregations:function(e){var t=this,a=[],r=[];for(var s in a=[],e)e[s].buckets.length>0&&(e[s].key=s,a.push(e[s]));for(var s in a.sort((function(e,t){return e.meta.sort-t.meta.sort})),a)r.push(this.prepareAggregation(a[s]));Promise.all(r).then((function(e){var a={dimension:e};a.depth=t.depth;var r=new CustomEvent("fmt:dimensionEvent",{detail:a});document.dispatchEvent(r)}))},translate:function(e,t){var a=this;return new Promise((function(r,s){var i=t.join(","),n="fr"===a.$store.state.lang?"fre":"eng",o=a.$store.state.geonetwork+"srv/api/registries/vocabularies/keyword?id="+encodeURIComponent(i)+"&thesaurus="+e+"&lang="+n;a.$http.get(o,{headers:{accept:"application/json"}}).then((function(e){r(e.body)}))}))},prepareAggregation:function(e){var t=this;return new Promise((function(a,r){var s=e.key,i=t.$store.state.lang;e.meta&&e.meta.label&&(s=e.meta.label[i]?e.meta.label[i]:e.meta.label);var n=t.aggregations[e.key].terms.field.split("."),o=n.length>1&&"key"===n[1],l={"@name":e.key,type:o?"associative":"simple",label:s,meta:e.meta,category:[]},u=e.meta&&e.meta.type||"dimension",m=e.buckets,h=t.$gn.groups,c=(i=t.$store.state.lang,[]),d=e.meta.thesaurus||null;m.forEach((function(t,a){if(m[a]["@value"]=t.key,"dimension"===u){if("groupOwner"===e.key)var r=h[t.key].label[i];else r=t.key;l.category.push({"@name":r,"@label":r,"@value":t.key,"@count":t.doc_count})}else if("select"!==u||o){var s=t.key.split("^"),n=s.pop();c.push(n),m[a].parent=s.join("^"),m[a].length=s.length,m[a]["@name"]=t.key,m[a]["@label"]=t.key,m[a]["@value"]=n,m[a]["@count"]=t.doc_count,delete t.doc_count}else console.log(r),console.log(t),l.category.push(t["@value"])})),o?t.translate(d,c).then((function(e){if(m.forEach((function(t,a){e[t["@value"]]&&(e[t["@value"]].label?m[a]["@label"]=e[t["@value"]].label:m[a]["@label"]=e[t["@value"]])})),"select"===u){var t=[];m.forEach((function(e){t.push({"@value":e["@value"],"@label":e["@label"]})}))}else t=function e(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return t.filter((function(e){return e.parent===a})).map((function(a){var r=e(t,a.key);return r.length>0&&(a.category=r),a}))}(m);l.category=t,a(l)})):a(l)}))},fill:function(e,t){e.depth=this.depth;var a=new CustomEvent("fmt:metadataListEvent",{detail:e});document.dispatchEvent(a)}}};var s=a(1900),i=a(9858);const n=a.n(i)();var o=(0,s.Z)(r,(function(){return(0,this._self._c)("div")}),[],!1,null,null,null);"function"==typeof n&&n(o);const l=o.exports},5237:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>d});var r=a(2321),s=a(5119),i=a(7345),n=a(3188),o=a(7989);const l={name:"FormaterSousCatalogue",components:{FormaterDrawBbox:n.Z,FormaterForm:r.Z,FormaterListMetadata:s.default,FormaterMetadata:function(){return a.e(811).then(a.bind(a,4811))},FormaterPaging:i.default,FormaterElasticsearchRequester:o.default},data:function(){return{currentUuid:null,first:!0,sortBy:"",metaDisplayed:null,metadatas:[],metadataListener:null,drawing:!1,aerisSearchListener:null,aerisResetListener:null,backListener:null,temporalExtent:{min:"1900-01-01",max:"now"}}},computed:{group:function(){var e=this.$gn.groups,t=this.$route.params.id.toLowerCase(),a=null;for(var r in e)e[r].label.fr.replace(" ","-").toLowerCase()===t&&(a=r);return a?e[a]:null}},watch:{$route:function(e,t){e.query.sortBy?this.sortBy=e.query.sortBy:this.sortBy=this.$store.state.orderBy}},created:function(){this.$store.state.metadata&&"FormaterLogin"!==this.$route.name?this.$router.replace({name:"Metadata",params:{uuid:this.$store.state.metadata}}):(this.$route.query.sortBy?this.sortBy=this.$route.query.sortBy:this.sortBy=this.$store.state.orderBy,this.initTemporalExtent(),this.keydownListener=this.checkEscape.bind(this),document.addEventListener("keydown",this.keydownListener))},mounted:function(){this.$store.state.metadata,this.$store.commit("services/resetCurrent"),this.$store.commit("parametersChange",{parameters:[],mapping:[],fixed:{},type:null})},destroyed:function(){document.removeEventListener("aerisSearchEvent",this.aerisSearchListener),this.aerisSearchListener=null,document.removeEventListener("aerisResetEvent",this.aerisResetListener),this.aerisResetListener=null},methods:{initTemporalExtent:function(){this.$store.state.temporalExtent&&this.$store.state.temporalExtent.min&&(this.temporalExtent.min=this.$store.state.temporalExtent.min),this.$store.temporalExtent&&this.$store.temporalExtent.max&&(this.temporalExtent.max=this.$store.temporalExtent.max)},closeSingle:function(){var e=new CustomEvent("fmt:closeMetadataEvent",{detail:{depth:2}});document.dispatchEvent(e),this.$store.commit("resetSelectedMetadata")},close:function(){this.$router.go(-1)},back:function(){this.$store.state.selectedMetadata?this.$store.commit("resetSelectedMetadata"):this.resetMetadata()},checkEscape:function(e){var t=e||window.event;(t.key?"Escape"===t.key||"Esc"===t.key:27===t.keyCode)&&this.$router.go(-1)},resetMetadata:function(){if(1!==this.metadatas.length||!this.metadatas[0].appRoot){if(this.metadatas.length>0&&this.metadatas.pop(),this.metadatas.length>0){var e=this.metadatas[this.metadatas.length-1];this.currentUuid=e.id;var t=e.disableType,a=e.osParameters,r=e.mapping,s=e.fixed,i=null,n=null;e.tempExtentBegin&&e.tempExtentBegin.substring&&(i=e.tempExtentBegin.substring(0,10)),e.tempExtentEnd&&e.tempExtentEnd.substring&&(n=e.tempExtentEnd.substring(0,10));var o={min:i||this.temporalExtent.min,max:n||this.temporalExtent.madivx};this.$store.commit("temporalChange",o)}else this.currentUuid=null,a=[],r=[],s={},t=null,this.$store.commit("services/resetCurrent"),this.$store.commit("temporalChange",this.temporalExtent);this.$store.commit("currentUuidChange",this.currentUuid),this.$store.commit("parametersChange",{parameters:a,mapping:r,fixed:s,type:t});var l=new CustomEvent("fmt:closeMetadataEvent",{detail:{depth:this.metadatas.length}});document.dispatchEvent(l)}},setParameters:function(e){e.depth&&(this.metadatas[e.depth-1].osParameters=e.osParameters,this.metadatas[e.depth-1].mapping=e.mapping,this.metadatas[e.depth-1].fixed=e.fixed,this.metadatas[e.depth-1].disableType=e.disableType),e.depth===this.metadatas.length&&this.$store.commit("parametersChange",{parameters:e.osParameters,mapping:e.mapping,fixed:e.fixed,type:e.type})},registerValues:function(e){e.depth&&this.metadatas[e.depth-1].osParameters.forEach((function(t){e.parameters[t.name]?t.value=e.parameters[t.name]:t.value=null}))},closeError:function(){this.$store.commit("removeError")}}};var u=a(1900),m=a(6282);const h=a.n(m)();var c=(0,u.Z)(l,(function(){var e=this,t=e._self._c;return t("div",{staticClass:"mtdt-catalogue"},[t("div",[e._v(e._s(e.metaDisplayed))]),e._v(" "),t("formater-elasticsearch-requester",{attrs:{group:e.group?e.group.id:null}}),e._v(" "),t("formater-draw-bbox"),e._v(" "),t("div",[t("div",{staticClass:"mtdt-column-left"},[e.group?t("div",[t("img",{staticStyle:{"max-height":"30px"},attrs:{src:e.group.logo}}),e._v(" "),t("span",{staticStyle:{"vertical-align":"middle","line-height":"50px"}},[e._v(e._s(e.group.label.fr))])]):e._e(),e._v(" "),t("formater-form",{attrs:{disableLevel:0,depth:0}})],1),e._v(" "),t("div",{staticClass:"mtdt-column-right"},[t("div",{attrs:{id:"fmtLargeMap"}}),e._v(" "),e.$store.state.searching?t("div",{staticClass:"fmt-waiting"},[t("div",[e._v(e._s(e.$t("searching"))),t("br"),t("span",{staticClass:"fa fa-spinner animated"})])]):e._e(),e._v(" "),e.$store.state.error?t("div",{staticClass:"fmt-error"},[t("div",[t("span",{staticClass:"fa fa-close fmt-close",on:{click:e.closeError}}),e._v(e._s(e.$store.state.error))])]):e._e(),e._v(" "),e.$store.state.selectedMetadata?t("div",{staticClass:"mtdt-free-capsule"},[t("div",[t("formater-metadata",{attrs:{metadata:e.$store.state.selectedMetadata,depth:-1},on:{close:function(t){return e.closeSingle()}}})],1)]):e._e(),e._v(" "),t("div",{directives:[{name:"show",rawName:"v-show",value:0===e.metadatas.length,expression:"metadatas.length === 0"}]},[t("formater-paging",{attrs:{depth:0,orders:["changeDate","popularity"],"order-by":e.sortBy}}),e._v(" "),t("formater-list-metadata",{attrs:{depth:0}})],1),e._v(" "),t("div",e._l(e.metadatas,(function(a,r){return t("formater-metadata",{directives:[{name:"show",rawName:"v-show",value:r===e.metadatas.length-1,expression:"index === metadatas.length-1"}],key:r,attrs:{depth:r+1,metadata:a},on:{parametersChange:e.setParameters,close:e.close}})})),1)])])],1)}),[],!1,null,null,null);"function"==typeof h&&h(c);const d=c.exports}}]);
//# sourceMappingURL=237.formater-metadata-vjs.js.map
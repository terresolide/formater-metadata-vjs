{"version":3,"sources":["webpack:///./src/capabilities-reader.js"],"names":["reader","$http","parser","regex","proxy","init","http","prox","DOMParser","RegExp","url","loadInfo","layer","options","metaId","callback","_this","this","href","test","search","encodeURIComponent","get","then","response","extract","body","str","root","parseFromString","ns","children","getAttribute","xlink","nsResolver","prefix","console","log","urlGetMap","getUrlGetMap","result","evaluate","name","XPathResult","ANY_TYPE","resultType","UNORDERED_NODE_ITERATOR_TYPE","ORDERED_NODE_ITERATOR_TYPE","layerXml","iterateNext","title","getTitle","id","ESPG","getESPG","format","getFormat","opacity","layers","legend","getLegend","resolver","STRING_TYPE","stringValue","NUMBER_TYPE","numberValue","getAbstract","getGeographicBoundingBox","src","module","exports"],"mappings":"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","file":"4.formater-metadata-vjs.js","sourcesContent":["/**\r\n * getCapabilities Reader\r\n */\r\n\r\nconst reader = {\r\n    $http: null,\r\n    parser: null,\r\n    regex: null,\r\n    proxy: null,\r\n    init (http,  prox) {\r\n      $http = http\r\n      parser = new DOMParser()\r\n      regex = new RegExp(prox.regex)\r\n      proxy = prox.url\r\n    },\r\n    loadInfo (layer, options, metaId, callback) {\r\n      var url = layer.href\r\n      if (regex.test(url)) {\r\n        search = proxy + '?url=' + encodeURIComponent(url)\r\n      }\r\n      $http.get(search)\r\n      .then(response => this.extract(response.body, layer, options, metaId, callback))\r\n    },\r\n    extract (str, layer, options, metaId, callback) {\r\n      var root = parser.parseFromString(str, 'text/xml')\r\n      var ns = root.children[0].getAttribute('xmlns')\r\n      var xlink = root.children[0].getAttribute('xmlns:xlink')\r\n      var nsResolver = function (prefix) {\r\n        switch(prefix) {\r\n          case 'xlink':\r\n            return xlink\r\n          default:\r\n            console.log(prefix)\r\n            return ns\r\n        }\r\n      }\r\n\r\n      var urlGetMap = this.getUrlGetMap(root, nsResolver)\r\n      if (urlGetMap === '') {\r\n        return null\r\n      }\r\n      options.url = urlGetMap\r\n      var result = null\r\n      result = root.evaluate('//ns:Layer[ns:Name=\"' + layer.name + '\"]', root, nsResolver, XPathResult.ANY_TYPE, null)\r\n      if (result.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE && result.resultType !== XPathResult.ORDERED_NODE_ITERATOR_TYPE) {\r\n        return null\r\n      }\r\n      var layerXml = result.iterateNext();\r\n      if (layerXml === null) {\r\n        return null\r\n      }\r\n      layer.href = urlGetMap\r\n     // layer.legend = this.getLegend(root, layerXml, nsResolver)\r\n      layer.title = this.getTitle(root, layerXml, nsResolver)\r\n      layer.options = {\r\n        id: layer.id,\r\n        ESPG: this.getESPG(root, layerXml, nsResolver),\r\n        format: this.getFormat(root, nsResolver),\r\n        opacity: 0.5,\r\n        layers: layer.name,\r\n        legend: this.getLegend(root, layerXml, nsResolver)\r\n      }\r\n     // options.title = this.getTitle(root, layerXml, nsResolver)\r\n    //  options.legend = this.getLegend(root, layerXml, nsResolver)\r\n//      options.format = this.getFormat(root, nsResolver)\r\n//      options.ESPG = this.getESPG(root, layerXml, nsResolver)\r\n//      options.layers = layer.name\r\n//      options.id = layer.id\r\n      // search crs and legend and bbox\r\n      if (typeof callback !== 'undefined') {\r\n        callback(layer, metaId)\r\n      }\r\n    },\r\n    getUrlGetMap( root, resolver) {\r\n      var result = root.evaluate('//ns:Request/ns:GetMap/ns:DCPType/ns:HTTP/ns:Get/ns:OnlineResource/@xlink:href', root, resolver, XPathResult.STRING_TYPE, null)\r\n      return result.stringValue\r\n    },\r\n    getESPG (root, layerXml, resolver) {\r\n      // default leaflet CRS\r\n      var result = root.evaluate('count(./ns:CRS[text()=\"EPSG:3857\"])', layerXml, resolver, XPathResult.NUMBER_TYPE, null)\r\n      if (result.numberValue > 0) {\r\n       return '3857'\r\n     }\r\n      var result = root.evaluate('count(./ns:CRS[text()=\"EPSG:4326\"])', layerXml, resolver, XPathResult.NUMBER_TYPE, null)\r\n      console.log(result)\r\n      if (result.numberValue > 0) {\r\n        return '4326'\r\n      }\r\n      var result = root.evaluate('count(./ns:CRS[text()=\"EPSG:3395\"])', layerXml, resolver, XPathResult.NUMBER_TYPE, null)\r\n      if (result.numberValue > 0) {\r\n        return '3395'\r\n      } else {\r\n        return null\r\n      }\r\n    },\r\n    getFormat (root, resolver) {\r\n      var result = root.evaluate('count(//ns:Request/ns:GetMap[ns:Format=\"image/png\"])', root, resolver, XPathResult.NUMBER_TYPE, null)\r\n      if (result.numberValue > 0) {\r\n        return 'image/png'\r\n      }\r\n      var result = root.evaluate('count(//ns:Request/ns:GetMap[ns:Format=\"image/jpeg\"])', root, resolver, XPathResult.NUMBER_TYPE, null)\r\n      if (result.numberValue > 0) {\r\n        return 'image/jpeg'\r\n      }\r\n      return null\r\n    },\r\n    getTitle (root, layerXml, resolver) {\r\n      var result = root.evaluate('./ns:Title/text()', layerXml, resolver, XPathResult.STRING_TYPE, null)\r\n      return result.stringValue\r\n    },\r\n    getAbstract (root, layerXml, resolver) {\r\n      var result = root.evaluate('./ns:Abstract/text()', layerXml, resolver, XPathResult.STRING_TYPE, null)\r\n      return result.stringValue\r\n    },\r\n    getGeographicBoundingBox (root, layerXml, resolver) {\r\n      \r\n    },\r\n    getLegend (root, layerXml, resolver) {\r\n      var result = root.evaluate('./ns:Style/ns:LegendURL/ns:OnlineResource/@xlink:href', layerXml, resolver, XPathResult.STRING_TYPE, null)\r\n      var src = result.stringValue\r\n      var result = root.evaluate('./ns:Style/ns:Title', layerXml, resolver, XPathResult.STRING_TYPE, null)\r\n      var title = result.stringValue\r\n      console.log(src)\r\n      if (src !== '') {\r\n        return {src: src, title: title}\r\n      } else {\r\n        return null\r\n      }\r\n      \r\n    }\r\n}\r\nmodule.exports = reader"],"sourceRoot":""}